<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IVANPLAYS Music Web</title>
  <meta name="description" content="IVANPLAYS Music Web â€” Generador musical con auto-mix en directo y composiciÃ³n algorÃ­tmica" />
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="favicon-32.png" sizes="32x32">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    (function(){
      const t1 = "ðŸŽµ IVANPLAYS Music Web";
      const t2 = "ðŸŽ¶ Create your sound";
      let toggle = false;
      setInterval(()=>{ document.title = toggle ? t1 : t2; toggle = !toggle; }, 2500);
    })();
  </script>
</head>
<body class="bg-neutral-950 text-neutral-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    const STEPS_PER_BAR = 16;
    const CREDITS_PER_SONG = 10;
    const PLANS = { free:{name:"Free",price:0,monthlyCredits:0}, pro:{name:"Pro",price:10,monthlyCredits:2500}, ultimate:{name:"Ultimate",price:30,monthlyCredits:9000} };
    const SCALES = {
      "Bumping 2000":[55,82.41,110,164.81,220,329.63,440],"Trance":[65.41,98,130.81,196,261.63,392,523.25],
      "LoFi":[73.42,110,146.83,185,220,261.63,293.66],"Pop":[82.41,123.47,164.81,185,246.94,329.63,392],
      "Hardbass":[55,73.42,110,146.83,220,293.66,440],"Deep House":[55,82.41,110,164.81,220,277.18,329.63],
      "Electronica":[65.41,92.5,130.81,185,261.63,311.13,392],"EDM":[58.27,87.31,116.54,174.61,233.08,349.23,466.16],
      "Techno":[65.41,98,130.81,196,261.63,392,523.25],"Drum & Bass":[55,110,165,220,330,440,660],
      "Trap":[61.74,92.5,123.47,184.99,246.94,277.18,369.99],"Reggaeton":[73.42,110,146.83,196,220,261.63,329.63],
      "Synthwave":[65.41,98,130.81,196,261.63,392,523.25],
    };
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    function makeRng(seed=1){ let s=seed>>>0; return ()=>{ s=(s*1664525+1013904223)>>>0; return (s/0xFFFFFFFF); }; }
    function degreeToFreq(scale,deg,octaveShift=0){ const idx=((deg%scale.length)+scale.length)%scale.length; const base=scale[idx]; return base*Math.pow(2,octaveShift); }
    function buildSongPlan(totalSec,bpm,rng){
      const secPerBar=(60/Math.max(60,Math.min(200,bpm)))*4; const totalBars=Math.max(8,Math.floor(totalSec/secPerBar));
      let layout=[{type:"intro",bars:Math.max(8,Math.floor(totalBars*0.12))},{type:"build",bars:Math.max(8,Math.floor(totalBars*0.18))},{type:"drop",bars:Math.max(16,Math.floor(totalBars*0.25))},{type:"break",bars:Math.max(8,Math.floor(totalBars*0.12))},{type:"drop2",bars:Math.max(16,Math.floor(totalBars*0.23))},{type:"outro",bars:Math.max(4,Math.floor(totalBars*0.10))}];
      const sum=layout.reduce((a,s)=>a+s.bars,0); let diff=totalBars-sum;
      while(diff!==0){ if(diff>0){layout[2].bars++; diff--;} else {layout[5].bars=Math.max(4,layout[5].bars-1); diff++;} }
      const map={intro:0.3,build:0.6,drop:1,break:0.4,drop2:0.95,outro:0.35}; return layout.map(s=>({...s,intensity:map[s.type]||0.6}));
    }
    const PROGRESSIONS={"Bumping 2000":[0,5,3,4],"Hardbass":[0,4,5,3],"Deep House":[0,3,4,5],"EDM":[0,4,5,4],"Trance":[0,3,4,3],"Techno":[0,0,5,0],"Trap":[0,5,4,3],"Drum & Bass":[0,5,0,4],"Pop":[0,4,5,4],"Electronica":[0,2,4,5],"Reggaeton":[0,5,3,4],"Synthwave":[0,3,4,3],"LoFi":[0,2,3,4]};

    async function renderTrackWithWebAudio({durationSec,bpm,style,samples,lyrics,speakLyrics,randomize}){
      const AudioCtx=window.AudioContext||window.webkitAudioContext; const ctx=new AudioCtx({sampleRate:44100});
      const master=ctx.createGain(); master.gain.value=0.85;
      const duck=ctx.createGain(); duck.gain.value=1.0;
      const limiter=ctx.createDynamicsCompressor(); limiter.threshold.value=-5; limiter.knee.value=15; limiter.ratio.value=12; limiter.attack.value=0.003; limiter.release.value=0.25;
      master.connect(duck).connect(limiter);
      const mediaDest=ctx.createMediaStreamDestination(); limiter.connect(mediaDest); limiter.connect(ctx.destination);

      function makeBus({hp=0,lp=0,gain=1}){const g=ctx.createGain();g.gain.value=gain;const hpF=ctx.createBiquadFilter();hpF.type="highpass";hpF.frequency.value=hp;const lpF=ctx.createBiquadFilter();lpF.type="lowpass";lpF.frequency.value=lp||20000;g.connect(hpF).connect(lpF).connect(master);return{in:g,hp:hpF,lp:lpF};}
      const busDrums=makeBus({hp:20,lp:18000,gain:1}); const busBass=makeBus({hp:20,lp:900,gain:0.95}); const busLead=makeBus({hp:150,lp:16000,gain:0.85}); const busFX=makeBus({hp:200,lp:16000,gain:0.6});
      const beat=60/clamp(bpm,60,200); const stepsPerBar=STEPS_PER_BAR; const stepDur=(beat*4)/stepsPerBar; const rng=makeRng(Math.floor((Math.abs(bpm)+style.length)*1000)); const scale=SCALES[style]||SCALES["Bumping 2000"];

      async function ensureBuffer(localBuf){ if(!localBuf) return null; const tmp=ctx.createBuffer(localBuf.numberOfChannels,localBuf.length,localBuf.sampleRate); for(let ch=0;ch<localBuf.numberOfChannels;ch++){ tmp.getChannelData(ch).set(localBuf.getChannelData(ch)); } return tmp; }
      const kick=await ensureBuffer(samples.kick); const snare=await ensureBuffer(samples.snare); const hihat=await ensureBuffer(samples.hihat); const bassS=await ensureBuffer(samples.bass); const vox=await ensureBuffer(samples.vox);

      function scheduleKickSynth(time){ const osc=ctx.createOscillator(); const g=ctx.createGain(); osc.type="sine"; osc.frequency.setValueAtTime(160,time); osc.frequency.exponentialRampToValueAtTime(45,time+0.11); g.gain.setValueAtTime(1.2,time); g.gain.exponentialRampToValueAtTime(0.0001,time+0.14); osc.connect(g).connect(busDrums.in); osc.start(time); osc.stop(time+0.16); }
      function scheduleHatSynth(time){ const noise=ctx.createBuffer(1,ctx.sampleRate*0.1,ctx.sampleRate); const data=noise.getChannelData(0); 
        for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1; const src=ctx.createBufferSource(); src.buffer=noise; const hp=ctx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=8000; hp.Q.value=0.7; const g=ctx.createGain(); g.gain.value=0.18; src.connect(hp).connect(g).connect(busDrums.in); src.start(time); src.stop(time+0.05); }
      function scheduleBassSynth(time,freq){ const osc=ctx.createOscillator(); const g=ctx.createGain(); osc.type=style==="Hardbass"?"square":"sawtooth"; osc.frequency.setValueAtTime(freq/2,time); g.gain.setValueAtTime(0.0001,time); g.gain.linearRampToValueAtTime(0.5,time+0.01); g.gain.exponentialRampToValueAtTime(0.0001,time+beat*0.95); osc.connect(g).connect(busBass.in); osc.start(time); osc.stop(time+beat); }
      function scheduleLeadSynth(time,freq){ const osc=ctx.createOscillator(); const g=ctx.createGain(); osc.type=(style==="Trance"||style==="EDM")?"sawtooth":"triangle"; osc.frequency.setValueAtTime(freq,time); g.gain.setValueAtTime(0.0001,time); g.gain.linearRampToValueAtTime(0.25,time+0.01); g.gain.exponentialRampToValueAtTime(0.0001,time+beat*0.5); osc.connect(g).connect(busLead.in); osc.start(time); osc.stop(time+beat*0.5); }
      function playSample(buf,toBus,time,{gain=1,detune=0}={}){ if(!buf) return; const src=ctx.createBufferSource(); const g=ctx.createGain(); src.buffer=buf; if(src.detune) src.detune.value=detune; g.gain.value=gain; src.connect(g).connect(toBus.in); src.start(time); }
      def_duck = duck
      def_duck_var = None
      def_duck_var = def_duck # keep the name used below

      def duckOn(time):
          pass

      # Using JS in a Python string - keep JS function in the HTML below
      return null
  </script>
</body>
</html>
