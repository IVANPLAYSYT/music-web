<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IVANPLAYS Music Web</title>
  <meta name="description" content="IVANPLAYS Music Web ‚Äî Generador musical con auto-mix en directo, composici√≥n algor√≠tmica y cr√©ditos/planes." />
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="favicon-32.png" sizes="32x32">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    (function(){
      const t1 = "üéµ IVANPLAYS Music Web";
      const t2 = "üé∂ Create your sound";
      let toggle = false;
      setInterval(()=>{ document.title = toggle ? t1 : t2; toggle = !toggle; }, 2500);
    })();
  </script>
</head>
<body class="bg-neutral-950 text-neutral-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    // -------------------- Config --------------------
    const STEPS_PER_BAR = 16;
    const CREDITS_PER_SONG = 10;

    const PLANS = {
      free:     { name: "Free",     price: 0,  monthlyCredits: 0    },
      pro:      { name: "Pro",      price: 10, monthlyCredits: 2500 },
      ultimate: { name: "Ultimate", price: 30, monthlyCredits: 9000 },
    };

    const SCALES = {
      "Bumping 2000": [55, 82.41, 110, 164.81, 220, 329.63, 440],
      "Trance":       [65.41, 98, 130.81, 196, 261.63, 392, 523.25],
      "LoFi":         [73.42, 110, 146.83, 185, 220, 261.63, 293.66],
      "Pop":          [82.41, 123.47, 164.81, 185, 246.94, 329.63, 392],
      "Hardbass":     [55, 73.42, 110, 146.83, 220, 293.66, 440],
      "Deep House":   [55, 82.41, 110, 164.81, 220, 277.18, 329.63],
      "Electronica":  [65.41, 92.5, 130.81, 185, 261.63, 311.13, 392],
      "EDM":          [58.27, 87.31, 116.54, 174.61, 233.08, 349.23, 466.16],
      "Techno":       [65.41, 98, 130.81, 196, 261.63, 392, 523.25],
      "Drum & Bass":  [55, 110, 165, 220, 330, 440, 660],
      "Trap":         [61.74, 92.5, 123.47, 184.99, 246.94, 277.18, 369.99],
      "Reggaeton":    [73.42, 110, 146.83, 196, 220, 261.63, 329.63],
      "Synthwave":    [65.41, 98, 130.81, 196, 261.63, 392, 523.25],
    };

    const PROGRESSIONS = {
      "Bumping 2000": [0,5,3,4], "Hardbass":[0,4,5,3], "Deep House":[0,3,4,5],
      "EDM":[0,4,5,4], "Trance":[0,3,4,3], "Techno":[0,0,5,0], "Trap":[0,5,4,3],
      "Drum & Bass":[0,5,0,4], "Pop":[0,4,5,4], "Electronica":[0,2,4,5],
      "Reggaeton":[0,5,3,4], "Synthwave":[0,3,4,3], "LoFi":[0,2,3,4]
    };

    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    function makeRng(seed=1){ let s = seed>>>0; return ()=>{ s=(s*1664525+1013904223)>>>0; return (s/0xFFFFFFFF); }; }
    function degreeToFreq(scale, deg, octaveShift=0){ const idx=((deg%scale.length)+scale.length)%scale.length; const base=scale[idx]; return base*Math.pow(2, octaveShift); }

    function buildSongPlan(totalSec, bpm, rng){
      const secPerBar = (60 / clamp(bpm, 60, 200)) * 4;
      const totalBars = Math.max(8, Math.floor(totalSec / secPerBar));
      let layout = [
        {type:"intro",  bars: Math.max(8,  Math.floor(totalBars*0.12))},
        {type:"build",  bars: Math.max(8,  Math.floor(totalBars*0.18))},
        {type:"drop",   bars: Math.max(16, Math.floor(totalBars*0.25))},
        {type:"break",  bars: Math.max(8,  Math.floor(totalBars*0.12))},
        {type:"drop2",  bars: Math.max(16, Math.floor(totalBars*0.23))},
        {type:"outro",  bars: Math.max(4,  Math.floor(totalBars*0.10))}
      ];
      const sum = layout.reduce((a,s)=>a+s.bars,0);
      let diff = totalBars - sum;
      while (diff !== 0){ if (diff>0){layout[2].bars++; diff--;} else {layout[5].bars=Math.max(4,layout[5].bars-1); diff++;} }
      const intensityMap = {intro:0.3, build:0.6, drop:1.0, break:0.4, drop2:0.95, outro:0.35};
      return layout.map(s=>({...s, intensity: intensityMap[s.type]||0.6}));
    }

    // -------------------- Motor de audio --------------------
    async function decodeSample(file){
      if (!file) return null;
      const buf = await file.arrayBuffer();
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx({ sampleRate: 44100 });
      const out = await ctx.decodeAudioData(buf.slice(0));
      await ctx.close();
      return out;
    }

    async function renderTrackWithWebAudio({ durationSec, bpm, style, samples, lyrics, speakLyrics, randomize }) {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx({ sampleRate: 44100 });

      // Master ‚Üí duck ‚Üí limiter ‚Üí destino / grabaci√≥n
      const master = ctx.createGain(); master.gain.value = 0.85;
      const duck   = ctx.createGain(); duck.gain.value   = 1.0;
      const limiter = ctx.createDynamicsCompressor();
      limiter.threshold.value = -5; limiter.knee.value = 15; limiter.ratio.value = 12; limiter.attack.value = 0.003; limiter.release.value = 0.25;
      master.connect(duck).connect(limiter);
      const mediaDest = ctx.createMediaStreamDestination();
      limiter.connect(mediaDest);                 // grabaci√≥n
      limiter.connect(ctx.destination);           // escucha en directo

      function makeBus({ hp = 0, lp = 0, gain = 1 }) {
        const g = ctx.createGain(); g.gain.value = gain;
        const hpF = ctx.createBiquadFilter(); hpF.type = "highpass"; hpF.frequency.value = hp;
        const lpF = ctx.createBiquadFilter(); lpF.type = "lowpass";  lpF.frequency.value = lp || 20000; // <- CORREGIDO
        g.connect(hpF).connect(lpF).connect(master);
        return { in: g, hp: hpF, lp: lpF };
      }
      const busDrums = makeBus({ hp: 20,  lp: 18000, gain: 1 });
      const busBass  = makeBus({ hp: 20,  lp: 900,   gain: 0.95 });
      const busLead  = makeBus({ hp: 150, lp: 16000, gain: 0.85 });
      const busFX    = makeBus({ hp: 200, lp: 16000, gain: 0.6 });

      function duckOn(time){
        duck.gain.cancelScheduledValues(time);
        duck.gain.setValueAtTime(duck.gain.value, time);
        duck.gain.linearRampToValueAtTime(0.6, time + 0.005);
        duck.gain.exponentialRampToValueAtTime(1.0, time + 0.22);
      }

      const beat = 60 / clamp(bpm, 60, 200);
      const stepsPerBar = STEPS_PER_BAR;
      const stepDur = (beat * 4) / stepsPerBar;
      const rng = makeRng(Math.floor((Math.abs(bpm)+style.length)*1000));
      const scale = SCALES[style] || SCALES["Bumping 2000"];

      async function ensureBuffer(localBuf){
        if (!localBuf) return null;
        const tmp = ctx.createBuffer(localBuf.numberOfChannels, localBuf.length, localBuf.sampleRate);
        for (let ch=0; ch<localBuf.numberOfChannels; ch++){ tmp.getChannelData(ch).set(localBuf.getChannelData(ch)); }
        return tmp;
      }
      const kick  = await ensureBuffer(samples.kick);
      const snare = await ensureBuffer(samples.snare);
      const hihat = await ensureBuffer(samples.hihat);
      const bassS = await ensureBuffer(samples.bass);
      const vox   = await ensureBuffer(samples.vox);

      // Sintetizadores de respaldo
      function scheduleKickSynth(time){
        const osc = ctx.createOscillator(); const g = ctx.createGain();
        osc.type = "sine"; osc.frequency.setValueAtTime(160,time);
        osc.frequency.exponentialRampToValueAtTime(45,time+0.11);
        g.gain.setValueAtTime(1.2,time); g.gain.exponentialRampToValueAtTime(0.0001,time+0.14);
        osc.connect(g).connect(busDrums.in); osc.start(time); osc.stop(time+0.16);
      }
      function scheduleHatSynth(time){
        const noise = ctx.createBuffer(1, ctx.sampleRate*0.1, ctx.sampleRate);
        const data = noise.getChannelData(0); for (let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
        const src = ctx.createBufferSource(); src.buffer=noise;
        const hp = ctx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=8000; hp.Q.value=0.7;
        const g = ctx.createGain(); g.gain.value=0.18; src.connect(hp).connect(g).connect(busDrums.in);
        src.start(time); src.stop(time+0.05);
      }
      function scheduleBassSynth(time, freq){
        const osc=ctx.createOscillator(); const g=ctx.createGain();
        osc.type = style==="Hardbass" ? "square" : "sawtooth"; osc.frequency.setValueAtTime(freq/2, time);
        g.gain.setValueAtTime(0.0001,time); g.gain.linearRampToValueAtTime(0.5,time+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001,time+beat*0.95);
        osc.connect(g).connect(busBass.in); osc.start(time); osc.stop(time+beat);
      }
      function scheduleLeadSynth(time, freq){
        const osc=ctx.createOscillator(); const g=ctx.createGain();
        osc.type = (style==="Trance"||style==="EDM") ? "sawtooth" : "triangle";
        osc.frequency.setValueAtTime(freq,time);
        g.gain.setValueAtTime(0.0001,time); g.gain.linearRampToValueAtTime(0.25,time+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001,time+beat*0.5);
        osc.connect(g).connect(busLead.in); osc.start(time); osc.stop(time+beat*0.5);
      }
      function playSample(buf, toBus, time, {gain=1, detune=0}={}){
        if (!buf) return; const src=ctx.createBufferSource(); const g=ctx.createGain();
        src.buffer=buf; if (src.detune) src.detune.value=detune; g.gain.value=gain;
        src.connect(g).connect(toBus.in); src.start(time);
      }

      const patt = {
        kick:  {"Hardbass":[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], default:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]},
        snare: {"Hardbass":[0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0], default:[0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0]},
        hihat: {"Hardbass":Array(16).fill(0).map((_,i)=> i%2===1?1:0), default:Array(16).fill(0).map((_,i)=> i%2===1?1:0)}
      };

      const plan = buildSongPlan(durationSec, bpm, rng);
      const progression = PROGRESSIONS[style] || PROGRESSIONS["Bumping 2000"];
      const secPerBar = beat*4;
      let curTime = ctx.currentTime + 0.05;
      let chordIdx = 0;

      for (const sec of plan){
        for (let b=0; b<sec.bars; b++){
          const addGhost = randomize && (rng() < sec.intensity * 0.55);
          const addFills = randomize && (rng() < Math.min(0.18 + sec.intensity*0.25, 0.4));

          for (let sIdx=0; sIdx<STEPS_PER_BAR; sIdx++){
            const t = curTime + sIdx * stepDur;

            const kOn = (patt.kick[style]||patt.kick.default)[sIdx] || (addFills && sec.type.includes("drop") && sIdx===15);
            if (kOn){ (kick ? playSample(kick, busDrums, t, {gain:1}) : scheduleKickSynth(t)); duckOn(t); }

            const sOn = (patt.snare[style]||patt.snare.default)[sIdx] || (addFills && sIdx===7);
            if (sOn){ snare ? playSample(snare, busDrums, t, {gain:0.9}) : scheduleKickSynth(t+0.01); }

            const hOn = (patt.hihat[style]||patt.hihat.default)[sIdx] || (addGhost && sIdx%2===1);
            if (hOn){ hihat ? playSample(hihat, busDrums, t, {gain:0.55+0.25*sec.intensity}) : scheduleHatSynth(t); }

            if (sIdx % 4 === 0){
              const deg = progression[chordIdx % progression.length];
              const f = degreeToFreq(scale, deg, style==="Hardbass"?-1:-0.5);
              bassS ? playSample(bassS, busBass, t, {gain:0.9}) : scheduleBassSynth(t, f);
            }
            if (sec.intensity > 0.45 && sIdx % 2 === 0){
              const deg = (progression[chordIdx % progression.length] + (rng()<0.5?2:1));
              scheduleLeadSynth(t, degreeToFreq(scale, deg, 0));
            }
          }

          if ((sec.type.includes("drop") || sec.type==="build") && vox && (b % 4 === 0)){
            playSample(vox, busFX, curTime, {gain:0.9});
          }

          master.gain.setTargetAtTime(0.6 + 0.4*sec.intensity, curTime, 0.01);
          curTime += secPerBar;
          if ((b+1) % 4 === 0) chordIdx++;
        }
        if (sec.type !== "outro"){
          const tr = curTime - stepDur*2; scheduleHatSynth(tr); scheduleKickSynth(tr + 0.03);
        }
      }

      if (speakLyrics && lyrics && window.speechSynthesis){
        const u = new SpeechSynthesisUtterance(lyrics);
        u.lang = "es-ES"; u.rate = clamp(bpm/120, 0.7, 1.4); window.speechSynthesis.speak(u);
      }

      // Grabaci√≥n WebM/Opus
      const chunks = [];
      const mime = (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported("audio/webm;codecs=opus"))
        ? "audio/webm;codecs=opus" : "audio/webm";
      const recorder = new MediaRecorder(mediaDest.stream, { mimeType: mime });
      const blobPromise = new Promise((resolve) => {
        recorder.ondataavailable = (e) => e.data.size && chunks.push(e.data);
        recorder.onstop = async () => {
          const blob = new Blob(chunks, { type: mime });
          try { await ctx.close(); } catch {}
          resolve(blob);
        };
      });
      recorder.start();
      const endTime = curTime + 0.2;
      setTimeout(()=>{ try{ recorder.stop(); }catch{} }, Math.ceil((endTime - ctx.currentTime) * 1000) + 100);
      const blob = await blobPromise;
      const url = URL.createObjectURL(blob);
      return { blob, url, meta: { mime, durationSec, bpm, style } };
    }

    // -------------------- App --------------------
    function App(){
      const [prompt, setPrompt] = React.useState("Melod√≠a en√©rgica, bumping/hardbass, vamos venga dale ‚ú®");
      const [lyrics, setLyrics] = React.useState("vamos, venga, dale ‚Äî rompe la pista!");
      const [speakLyrics, setSpeakLyrics] = React.useState(false);
      const [style, setStyle] = React.useState("Bumping 2000");
      const [bpm, setBpm] = React.useState(150);
      const [duration, setDuration] = React.useState(60);
      const [seed, setSeed] = React.useState(42);
      const [randomize, setRandomize] = React.useState(true);

      const [isGenerating, setIsGenerating] = React.useState(false);
      const [progress, setProgress] = React.useState(0);
      const [audioURL, setAudioURL] = React.useState("");
      const [tracks, setTracks] = React.useState([]);
      const progRef = React.useRef(null);

      const [kickFile, setKickFile] = React.useState(null);
      const [snareFile, setSnareFile] = React.useState(null);
      const [hihatFile, setHihatFile] = React.useState(null);
      const [bassFile, setBassFile] = React.useState(null);
      const [voxFile, setVoxFile] = React.useState(null);
      const [decoded, setDecoded] = React.useState({kick:null, snare:null, hihat:null, bass:null, vox:null});

      React.useEffect(()=>()=>{ if (audioURL) URL.revokeObjectURL(audioURL); },[audioURL]);
      React.useEffect(()=>{ (async()=>{
        const [k,s,h,b,v] = await Promise.all([decodeSample(kickFile), decodeSample(snareFile), decodeSample(hihatFile), decodeSample(bassFile), decodeSample(voxFile)]);
        setDecoded({kick:k, snare:s, hihat:h, bass:b, vox:v});
      })(); }, [kickFile, snareFile, hihatFile, bassFile, voxFile]);

      const [credits, setCredits] = React.useState(()=>{ const saved=localStorage.getItem("demo_credits"); return saved?Number(saved):100; });
      const [plan, setPlan] = React.useState(()=>{ const saved=localStorage.getItem("demo_plan"); return (saved==="pro"||saved==="ultimate"||saved==="free")?saved:"free"; });
      React.useEffect(()=>{ localStorage.setItem("demo_credits", String(credits)); },[credits]);
      React.useEffect(()=>{ localStorage.setItem("demo_plan", plan); },[plan]);
      React.useEffect(()=>{ const key=`demo_lastCreditUpdate_${plan}`; const last=localStorage.getItem(key); const now=Date.now(); const month=1000*60*60*24*30; if(!last || now-Number(last)>month){ setCredits(c=>c+PLANS[plan].monthlyCredits); localStorage.setItem(key, String(now)); } },[plan]);

      async function handleGenerate(e){
        e?.preventDefault(); if (isGenerating) return;
        if (credits < CREDITS_PER_SONG){ alert(`No tienes suficientes cr√©ditos. Necesitas ${CREDITS_PER_SONG} y te quedan ${credits}.`); return; }
        setIsGenerating(true); setProgress(0); setAudioURL("");
        const start = performance.now(); const est = Math.max(4000, duration*1000+1500);
        const tick = (now)=>{ setProgress(clamp(((now-start)/est)*100, 0, 99)); progRef.current=requestAnimationFrame(tick); };
        progRef.current = requestAnimationFrame(tick);
        const bpmJitter = ((seed%7)-3)*0.7;
        const res = await renderTrackWithWebAudio({
          durationSec: clamp(Number(duration), 60, 420),
          bpm: clamp(Number(bpm)+bpmJitter, 60, 200),
          style, samples: decoded, lyrics, speakLyrics, randomize,
        });
        if (progRef.current) cancelAnimationFrame(progRef.current);
        setProgress(100); setAudioURL(res.url); setIsGenerating(false);
        setCredits(c=> Math.max(0, c - CREDITS_PER_SONG));
        setTracks(prev=> [{ id: Date.now().toString(), url: res.url, createdAt: new Date().toISOString(), meta: res.meta, prompt, lyrics, style }, ...prev].slice(0,6));
      }

      const genres = ["Bumping 2000","Trance","LoFi","Pop","Hardbass","Deep House","Electronica","EDM","Techno","Drum & Bass","Trap","Reggaeton","Synthwave"];

      return (
        <div className="min-h-screen flex flex-col items-center px-4 py-8">
          <div className="max-w-5xl w-full">
            <header className="mb-6">
              <h1 className="text-3xl md:text-4xl font-extrabold tracking-tight">Generador musical</h1>
              <p className="text-neutral-400 mt-1">Auto-mix en directo ‚Ä¢ 1‚Äì7 min ‚Ä¢ Random estilo Suno ‚Ä¢ Cr√©ditos y Planes</p>
            </header>

            {/* Cr√©ditos y Planes */}
            <section className="mb-6 grid gap-4 md:grid-cols-12">
              <div className="md:col-span-5 p-4 rounded-2xl bg-neutral-900 border border-neutral-800">
                <h3 className="text-lg font-semibold">Cr√©ditos</h3>
                <p className="text-neutral-400 text-sm mt-1">Coste por canci√≥n: <b>{CREDITS_PER_SONG}</b> cr√©ditos.</p>
                <div className="mt-3 flex items-center gap-3"><div className="text-2xl font-bold">{credits}</div><span className="text-neutral-400">cr√©ditos disponibles</span></div>
                <div className="mt-3 flex gap-2">
                  <button type="button" onClick={()=> setCredits(c=>c+10)} className="rounded-xl px-3 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 text-sm">+10 (demo)</button>
                  <button type="button" onClick={()=> setCredits(c=>c+50)} className="rounded-xl px-3 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 text-sm">+50 (demo)</button>
                </div>
                <p className="text-xs text-neutral-500 mt-2">Los cr√©ditos se descuentan al finalizar un render exitoso.</p>
              </div>

              <div className="md:col-span-7 p-4 rounded-2xl bg-neutral-900 border border-neutral-800">
                <h3 className="text-lg font-semibold">Planes</h3>
                <div className="mt-3 grid sm:grid-cols-2 gap-3">
                  <div className={`p-3 rounded-xl border ${plan==='pro'?'border-emerald-500 bg-emerald-500/10':'border-neutral-700 bg-neutral-950'}`}>
                    <div className="flex items-baseline justify-between"><div className="font-semibold">Pro</div><div className="text-xl">10‚Ç¨<span className="text-sm text-neutral-400">/mes</span></div></div>
                    <ul className="mt-2 text-sm text-neutral-300 list-disc ml-5"><li>2.500 cr√©ditos mensuales (~500 canciones)</li><li>Soporte prioritario (demo)</li></ul>
                    <button type="button" onClick={()=> setPlan('pro')} className="mt-3 w-full rounded-lg px-3 py-2 bg-emerald-500 hover:bg-emerald-400 text-neutral-950 font-medium">{plan==='pro'?'Plan activo':'Elegir Pro'}</button>
                  </div>
                  <div className={`p-3 rounded-xl border ${plan==='ultimate'?'border-emerald-500 bg-emerald-500/10':'border-neutral-700 bg-neutral-950'}`}>
                    <div className="flex items-baseline justify-between"><div className="font-semibold">Ultimate</div><div className="text-xl">30‚Ç¨<span className="text-sm text-neutral-400">/mes</span></div></div>
                    <ul className="mt-2 text-sm text-neutral-300 list-disc ml-5"><li>9.000 cr√©ditos mensuales (~1.800 canciones)</li><li>L√≠mites ampliados (demo)</li></ul>
                    <button type="button" onClick={()=> setPlan('ultimate')} className="mt-3 w-full rounded-lg px-3 py-2 bg-emerald-500 hover:bg-emerald-400 text-neutral-950 font-medium">{plan==='ultimate'?'Plan activo':'Elegir Ultimate'}</button>
                  </div>
                </div>
                <p className="text-xs text-neutral-400 mt-2">En esta demo los planes a√±aden cr√©ditos mensuales autom√°ticamente.</p>
              </div>
            </section>

            {/* Formulario principal */}
            <form onSubmit={handleGenerate} className="grid gap-4 md:grid-cols-12 items-start">
              <label className="md:col-span-12"><span className="text-sm text-neutral-300">Prompt</span>
                <textarea value={prompt} onChange={(e)=>setPrompt(e.target.value)} rows={2} className="mt-1 w-full rounded-2xl bg-neutral-900 border border-neutral-800 p-3 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
              </label>
              <label className="md:col-span-12"><span className="text-sm text-neutral-300">Lyrics (TTS para pre-escucha)</span>
                <textarea value={lyrics} onChange={(e)=>setLyrics(e.target.value)} rows={2} className="mt-1 w-full rounded-2xl bg-neutral-900 border border-neutral-800 p-3" />
                <label className="mt-2 flex items-center gap-2 text-sm text-neutral-300"><input type="checkbox" checked={speakLyrics} onChange={(e)=> setSpeakLyrics(e.target.checked)} />Leer lyrics con voz sint√©tica</label>
              </label>
              <div className="md:col-span-4"><span className="text-sm text-neutral-300">G√©nero / Estilo</span>
                <select value={style} onChange={(e)=>setStyle(e.target.value)} className="mt-1 w-full rounded-2xl bg-neutral-900 border border-neutral-800 p-3">{genres.map(g=> <option key={g}>{g}</option>)}</select>
              </div>
              <div className="md:col-span-3"><span className="text-sm text-neutral-300">BPM</span>
                <input type="number" value={bpm} min={60} max={200} onChange={(e)=>setBpm(Number(e.target.value))} className="mt-1 w-full rounded-2xl bg-neutral-900 border border-neutral-800 p-3" />
              </div>
              <div className="md:col-span-3"><span className="text-sm text-neutral-300">Duraci√≥n</span>
                <select value={duration} onChange={(e)=>setDuration(Number(e.target.value))} className="mt-1 w-full rounded-2xl bg-neutral-900 border border-neutral-800 p-3">
                  <option value={60}>1 minuto</option><option value={120}>2 minutos</option><option value={180}>3 minutos</option><option value={300}>5 minutos</option><option value={420}>7 minutos</option>
                </select>
              </div>
              <div className="md:col-span-2"><span className="text-sm text-neutral-300">Seed</span>
                <input type="number" value={seed} onChange={(e)=>setSeed(Number(e.target.value))} className="mt-1 w-full rounded-2xl bg-neutral-900 border border-neutral-800 p-3" />
              </div>
              <div className="md:col-span-2">
                <label className="flex items-center gap-2 mt-6 text-sm text-neutral-300">
                  <input type="checkbox" checked={true} onChange={()=>{}} disabled /> Auto-mix en directo
                </label>
                <label className="flex items-center gap-2 mt-3 text-sm text-neutral-300">
                  <input type="checkbox" checked={randomize} onChange={(e)=> setRandomize(e.target.checked)} /> Random estilo Suno
                </label>
              </div>

              <div className="md:col-span-12 grid md:grid-cols-5 gap-3">
                <label className="block"><span className="text-sm text-neutral-300">Kick (WAV/MP3)</span><input type="file" accept="audio/*" onChange={(e)=>setKickFile(e.target.files?.[0]||null)} className="mt-1 w-full text-sm" /></label>
                <label className="block"><span className="text-sm text-neutral-300">Snare/Clap</span><input type="file" accept="audio/*" onChange={(e)=>setSnareFile(e.target.files?.[0]||null)} className="mt-1 w-full text-sm" /></label>
                <label className="block"><span className="text-sm text-neutral-300">Hi-hat</span><input type="file" accept="audio/*" onChange={(e)=>setHihatFile(e.target.files?.[0]||null)} className="mt-1 w-full text-sm" /></label>
                <label className="block"><span className="text-sm text-neutral-300">Bajo (one-shot/loop)</span><input type="file" accept="audio/*" onChange={(e)=>setBassFile(e.target.files?.[0]||null)} className="mt-1 w-full text-sm" /></label>
                <label className="block"><span className="text-sm text-neutral-300">Vox (shouts/one-shot)</span><input type="file" accept="audio/*" onChange={(e)=>setVoxFile(e.target.files?.[0]||null)} className="mt-1 w-full text-sm" /></label>
              </div>

              <div className="md:col-span-12 flex gap-3 items-end">
                <button type="submit" disabled={isGenerating || credits < CREDITS_PER_SONG}
                  className={`rounded-2xl px-5 py-3 font-semibold shadow-sm transition ${isGenerating ? "bg-neutral-800 text-neutral-400" : "bg-emerald-500 hover:bg-emerald-400 text-neutral-950"}`}>
                  {isGenerating ? "Generando‚Ä¶" : `Generar pista (${CREDITS_PER_SONG} cr√©ditos)`}
                </button>
                <button type="button" onClick={()=>{ setTracks([]); setAudioURL(""); setProgress(0); }}
                  className="rounded-2xl px-4 py-3 font-medium bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">Limpiar</button>
              </div>
            </form>

            <div className="mt-6">
              <div className="h-3 w-full bg-neutral-900 rounded-full overflow-hidden border border-neutral-800"><div className="h-full bg-emerald-500" style={{ width: `${progress}%` }} /></div>
              <div className="mt-2 text-sm text-neutral-400">{isGenerating ? `Procesando (${progress.toFixed(0)}%)‚Ä¶` : (progress === 100 && audioURL ? "Listo" : "Esperando entrada")}</div>
            </div>

            {audioURL && (<div className="mt-6 p-4 rounded-2xl bg-neutral-900 border border-neutral-800"><h2 className="text-lg font-semibold mb-2">Resultado</h2><audio controls src={audioURL} className="w-full" /><div className="mt-3 flex flex-wrap gap-3 items-center"><a href={audioURL} download={`demo-${Date.now()}.webm`} className="underline text-emerald-400 hover:text-emerald-300">Descargar</a><span className="text-sm text-neutral-400">Formato: webm/opus ‚Ä¢ Grabado mientras suena</span>{(kickFile||snareFile||hihatFile||bassFile||voxFile) && (<span className="text-xs px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/30">Usando samples</span>)}</div></div>)}

            <div className="mt-8"><h3 className="text-xl font-bold mb-3">Historial (local)</h3>{tracks.length===0 ? (<p className="text-neutral-400">Cuando generes pistas, aparecer√°n aqu√≠.</p>) : (<ul className="grid md:grid-cols-2 gap-4">{tracks.map((t)=>(<li key={t.id} className="p-4 rounded-2xl bg-neutral-900 border border-neutral-800"><div className="text-sm text-neutral-400">{new Date(t.createdAt).toLocaleString()}</div><div className="mt-1 text-neutral-200 line-clamp-2">{t.prompt}</div>{t.lyrics && <div className="mt-1 text-sm text-emerald-300 line-clamp-2">‚Äú{t.lyrics}‚Äù</div>}<div className="mt-1 text-sm text-neutral-400">{t.meta?.style} ‚Ä¢ {t.meta?.bpm} BPM ‚Ä¢ {t.meta?.durationSec}s</div><audio controls src={t.url} className="mt-2 w-full" /><a href={t.url} download={`demo-${t.id}.webm`} className="mt-2 inline-block underline text-emerald-400 hover:text-emerald-300">Descargar</a></li>))}</ul>)}</div>

            <section className="mt-10 p-4 rounded-2xl bg-neutral-900 border border-neutral-800 text-sm text-neutral-300"><h4 className="text-neutral-100 font-semibold mb-2">¬øD√≥nde pongo los sonidos?</h4><ol className="list-decimal ml-5 space-y-2"><li>Sube tus one-shots o loops (WAV/MP3) en los campos de carga.</li><li>Si dejas alguno vac√≠o, se usa un peque√±o sintetizador de respaldo.</li><li>Las lyrics se pueden pre-escuchar con TTS marcando ‚ÄúLeer lyrics‚Äù.</li></ol><p className="mt-2 text-neutral-400">Demo local. Para IA real habr√≠a que conectar un modelo/servicio en backend.</p></section>

            <footer className="mt-6 text-xs text-neutral-500">‚ö†Ô∏è Demo para previsualizar. Funciona mejor bajo HTTPS (GitHub Pages lo proporciona).</footer>
          </div>
        </div>
      );
    }

    const genres = ["Bumping 2000","Trance","LoFi","Pop","Hardbass","Deep House","Electronica","EDM","Techno","Drum & Bass","Trap","Reggaeton","Synthwave"];
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
